name: Smart Release - VS Code Extension

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'  # Âè™Âú®package.jsonÂèòÂåñÊó∂Ëß¶Âèë
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

# Ê∑ªÂä†ÊòéÁ°ÆÁöÑÊùÉÈôêÈÖçÁΩÆ
permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    environment: production  # ÊåáÂÆö‰ΩøÁî®environment
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤‰ª•ÊØîËæÉÁâàÊú¨
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check if version changed
      id: check_version
      run: |
        # Ëé∑ÂèñÂΩìÂâçÁâàÊú¨
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™Êèê‰∫§ÁöÑÁâàÊú¨
        PREVIOUS_VERSION=$(git show HEAD~1:package.json 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8')).version" 2>/dev/null || echo "0.0.0")
        echo "Previous version: $PREVIOUS_VERSION"
        
        # Ê£ÄÊü•ÁâàÊú¨ÊòØÂê¶ÂèòÂåñ
        if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
          echo "‚úÖ Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è Version unchanged: $CURRENT_VERSION"
          echo "should-release=false" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        fi
        
    - name: Build extension
      if: steps.check_version.outputs.should-release == 'true'
      run: npm run compile
      
    - name: Package extension
      if: steps.check_version.outputs.should-release == 'true'
      run: |
        # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        if [ -d "temp-vsix" ]; then
          rm -rf temp-vsix
        fi
        npm run package
      
    - name: Create VSIX filename
      if: steps.check_version.outputs.should-release == 'true'
      id: filename
      run: |
        VERSION=${{ steps.check_version.outputs.version }}
        FILENAME="jsonstr-$VERSION.vsix"
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        echo "VSIX filename: $FILENAME"
        
    - name: Upload VSIX artifact
      if: steps.check_version.outputs.should-release == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: vscode-extension
        path: ${{ steps.filename.outputs.filename }}
        
    - name: Publish to VS Code Marketplace
      if: steps.check_version.outputs.should-release == 'true'
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
        FILENAME: ${{ steps.filename.outputs.filename }}
        RELEASE_VERSION: ${{ steps.check_version.outputs.version }}
      run: |
        # ÂÆâË£Ö vsce
        npm install -g @vscode/vsce
        
        # È™åËØÅ package.json
        echo "Validating package.json..."
        node -e "
          const fs = require('fs');
          const pkg = require('./package.json');
          console.log('Name:', pkg.name);
          console.log('Version:', pkg.version);
          console.log('Publisher:', pkg.publisher);
          console.log('DisplayName:', pkg.displayName);
          console.log('Description:', pkg.description);
          console.log('Icon:', pkg.icon);
          console.log('Icon exists:', fs.existsSync(pkg.icon));
        "
        
        # È™åËØÅ VSIX Êñá‰ª∂
        echo "Validating VSIX file..."
        vsce ls "$FILENAME"
        
        # ËøêË°å VSIX Ê£ÄÊü•ËÑöÊú¨
        echo "Running VSIX validation script..."
        npm run check:vsix
        
        # Ê£ÄÊü• PAT
        echo "Checking VSCE_PAT secret..."
        if [ -z "$VSCE_PAT" ]; then
          echo "‚ùå VSCE_PAT secret is NOT set"
          echo "Please set VSCE_PAT secret in GitHub repository settings"
          exit 1
        else
          echo "‚úÖ VSCE_PAT secret is set"
          echo "PAT length: ${#VSCE_PAT} characters"
        fi
        
        # Ê£ÄÊü• VSIX Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
        if [ ! -f "$FILENAME" ]; then
          echo "‚ùå VSIX file not found: $FILENAME"
          exit 1
        fi
        
        # ÂèëÂ∏É
        echo "Attempting to publish version $RELEASE_VERSION..."
        if vsce publish --pat "$VSCE_PAT" --packagePath "$FILENAME" --no-dependencies; then
          echo "‚úÖ Successfully published to VS Code Marketplace"
        else
          echo "‚ùå Failed to publish to VS Code Marketplace"
          echo "Possible reasons:"
          echo "1. Version already exists in marketplace"
          echo "2. PAT is invalid or expired"
          echo "3. Publisher ID mismatch"
          echo "4. Extension metadata issues"
          exit 1
        fi
        
    - name: Create GitHub Release
      if: steps.check_version.outputs.should-release == 'true'
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.check_version.outputs.version }}
        name: Release v${{ steps.check_version.outputs.version }}
        body: |
          ## JSON String Converter Extension v${{ steps.check_version.outputs.version }}
          
          ### üöÄ What's New
          - Auto-built and published to VS Code Marketplace
          - Version: ${{ steps.check_version.outputs.version }}
          
          ### üì¶ Installation
          **From VS Code Marketplace:**
          1. Open VS Code
          2. Go to Extensions (Ctrl+Shift+X)
          3. Search for "jsonstr"
          4. Click Install
          
          **Manual Installation:**
          1. Download the `.vsix` file from this release
          2. Open VS Code
          3. Go to Extensions (Ctrl+Shift+X)
          4. Click the "..." menu and select "Install from VSIX..."
          5. Select the downloaded file
          
          ### ‚ú® Features
          - JSON format detection and conversion
          - Auto-detection mode (configurable)
          - Preserve indentation format
          - Silent mode support
          - Shortcut: Ctrl+Shift+T (Windows/Linux) or Cmd+Shift+T (Mac)
          
          ### üîß Configuration
          - Auto-detection: `jsonstr.autoDetection`
          - Preserve indentation: `jsonstr.preserveIndentation`
          - Show notifications: `jsonstr.showNotifications`
        files: ${{ steps.filename.outputs.filename }}
        draft: false
        prerelease: false
        generate_release_notes: true
        
    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request' && steps.check_version.outputs.should-release == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üéâ **Extension v${{ steps.check_version.outputs.version }} published!**
            
            ‚úÖ Built and published to VS Code Marketplace
            üì¶ VSIX file available in release artifacts
            üîó [View Release](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/v${{ steps.check_version.outputs.version }})
            `
          })